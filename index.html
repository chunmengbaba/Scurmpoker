<!DOCTYPE html>
<html lang="zh-TW">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Scrum Poker - 敏捷估點</title>
    <!-- 載入 Tailwind CSS -->
    <script src="https://cdn.tailwindcss.com"></script>
    <script>
        tailwind.config = {
            theme: {
                extend: {
                    fontFamily: {
                        // 使用 Noto Sans TC 作為主要中文字體
                        sans: ['Inter', 'Noto Sans TC', 'sans-serif'],
                    },
                }
            }
        }
    </script>
    <!-- 載入 React 和 Babel -->
    <script src="https://unpkg.com/react@18/umd/react.development.js"></script>
    <script src="https://unpkg.com/react-dom@18/umd/react-dom.development.js"></script>
    <script src="https://unpkg.com/@babel/standalone/babel.min.js"></script>
    <!-- 載入 Lucide Icons (必須在 Babel 腳本前載入) -->
    <script src="https://unpkg.com/lucide@latest"></script>
    
    <!-- 載入 Firebase 模組化 SDK -->
    <script type="module">
        import { initializeApp } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-app.js";
        import { getAuth, signInAnonymously, onAuthStateChanged, signInWithCustomToken } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-auth.js";
        import { getFirestore, doc, onSnapshot, setDoc, updateDoc } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-firestore.js";

        // 將必要的 Firebase 函數和變數暴露給全域 window 物件，供 Babel 腳本使用
        window.FirebaseSDK = {
            initializeApp, getAuth, signInAnonymously, onAuthStateChanged, signInWithCustomToken,
            getFirestore, doc, onSnapshot, setDoc, updateDoc 
        };

        // 傳遞 Canvas 環境變數
        window.__scrum_poker_app_id = typeof __app_id !== 'undefined' ? __app_id : 'default-app-id';
        window.__scrum_poker_firebase_config = typeof __firebase_config !== 'undefined' ? JSON.parse(__firebase_config) : {};
        window.__scrum_poker_auth_token = typeof __initial_auth_token !== 'undefined' ? __initial_auth_token : null;
    </script>

    <style>
        /* 隱藏滾動條 */
        .hide-scrollbar {
            -ms-overflow-style: none;  /* IE and Edge */
            scrollbar-width: none;  /* Firefox */
        }
        .hide-scrollbar::-webkit-scrollbar {
            display: none;  /* Chrome, Safari and Opera */
        }
        /* 簡單的動畫 */
        @keyframes fadeIn {
            from { opacity: 0; transform: translateY(10px); }
            to { opacity: 1; transform: translateY(0); }
        }
        .animate-fade-in {
            animation: fadeIn 0.5s ease-out forwards;
        }
    </style>
</head>
<body>
    <div id="root"></div>

    <script type="text/babel">
        // --- 獲取全域變數和 Firebase SDK ---
        const { useState, useEffect, useMemo } = React;
        
        // 確保 lucide 全局變數存在，以避免解構錯誤
        const lucideIcons = typeof lucide !== 'undefined' ? lucide : {};

        // 將 Lucide Icons 重新命名並安全解構，確保 React 將它們識別為元件
        const { 
            User: UserIcon, 
            Copy: CopyIcon, 
            Eye: EyeIcon, 
            RotateCcw: RotateCcwIcon, 
            LogOut: LogOutIcon, 
            Info: InfoIcon 
        } = lucideIcons; 

        const FB = window.FirebaseSDK || {};
        const { 
            initializeApp, getAuth, signInAnonymously, onAuthStateChanged, signInWithCustomToken,
            getFirestore, doc, onSnapshot, setDoc, updateDoc 
        } = FB;

        let db, auth, appId;
        const isFirebaseAvailable = window.__scrum_poker_firebase_config && Object.keys(window.__scrum_poker_firebase_config).length > 0;
        
        if (isFirebaseAvailable) {
            try {
                const firebaseConfig = {
                    apiKey: "AIzaSyDHBMK_9sWyQVZlM_avyJtS7-r8XdmQQuE",
                    authDomain: "scurmpoker.firebaseapp.com",
                    projectId: "scurmpoker",
                    storageBucket: "scurmpoker.firebasestorage.app",
                    messagingSenderId: "73220832696",
                    appId: "1:73220832696:web:a8d7f6c1556cea032be34d",
                    measurementId: "G-SK17HW3WFV"
                };

                const app = initializeApp(firebaseConfig);
                auth = getAuth(app);
                db = getFirestore(app);
                appId = window.__scrum_poker_app_id;
            } catch (e) {
                console.error("Firebase initialization failed:", e);
            }
        }

        // --- Constants ---
        const FIBONACCI = ['0', '1', '2', '3', '5', '8', '13', '21', '34', '55', '89', '?', '☕'];

        // 檢查圖標元件是否有效 (如果無效，返回一個簡單的空元件)
        const SafeIcon = ({ Icon, className }) => {
            return typeof Icon === 'function' 
                ? <Icon className={className} /> 
                : <svg className={className} fill="none" viewBox="0 0 24 24" stroke="currentColor"><circle cx="12" cy="12" r="10" strokeWidth="2"/></svg>;
        };


        // --- Components ---

        // 卡片元件
        const Card = ({ value, selected, onClick, hidden = false }) => {
          if (hidden) {
            return (
              <div className={`
                relative w-14 h-20 sm:w-16 sm:h-24 rounded-lg shadow-md border-2 transition-all duration-300 transform
                ${selected ? '-translate-y-2 border-blue-500 shadow-blue-200' : 'border-slate-200 bg-slate-100'}
                flex items-center justify-center
              `}>
                <div className="w-full h-full rounded bg-blue-500 op
